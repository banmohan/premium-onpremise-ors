#!/bin/bash

CWD=$(pwd)

ORS_API_KEY=no-need-for-local-run
BITLY_API_KEY=bitlyApiKey
BITLY_LOGIN=bitlyLogin

if [[ $EUID -ne 0 ]]; then
    echo "This script should run as the root user (sudo)."
    echo "Use sudo or run as root user."
    exit 1
fi

docker compose down -v --rmi all --remove-orphans
mkdir -p ors-map-client
cd ors-map-client
docker compose down -v --rmi all --remove-orphans

rm -f docker-compose.yml*
wget https://raw.githubusercontent.com/GIScience/openrouteservice/master/docker-compose.yml
sed -i "s/8080:/9980:/g" docker-compose.yml
sed -i "s/9001:/9901:/g" docker-compose.yml
sed -i "s/BUILD_GRAPHS=False/BUILD_GRAPHS=True/g" docker-compose.yml
sed -i "s|#    build:|    build:|g" docker-compose.yml
sed -i "s|#      context: ./|      context: ./|g" docker-compose.yml
sed -i "s|#      args:|      args:|g" docker-compose.yml
sed -i "s|#        OSM_FILE: ./ors-api/src/test/files/heidelberg.osm.gz|        OSM_FILE: ./map.osm.pbf|g" docker-compose.yml

rm -rf ors-map-client
git clone https://github.com/GIScience/ors-map-client.git
cd ors-map-client/src && cp config-examples/* config && for i in config/*-example.js; do mv -- "$i" "${i%-example.js}.js"; done
cd $CWD/ors-map-client/src/config
sed -i "s|$ORS_API_KEY|put-here-an-ors-api-key|g" app-config.js
sed -i "s|$BITLY_API_KEY|put-the-bitly-api-key-here|g" app-config.js
sed -i "s|$BITLY_LOGIN|put-the-bitly-login-here|g" app-config.js
sed -i "s|useORSMenu: false|useORSMenu: true|g" app-config.js
sed -i "s|appName: 'Premium Maps'|appName: 'Openrouteservice Maps'|g" app-config.js
sed -i "s|footerAppName: 'Premium'|footerAppName: 'openrouteservice'|g" app-config.js
sed -i "s|footerDevelopedByLink: 'https://www.premiumtech.com.np/'|footerDevelopedByLink: 'https://www.heigit.org/'|g" app-config.js
sed -i "s|http://localhost:9980|https://api.openrouteservice.org|g" app-config.js
cd $CWD/ors-map-client
sed -i "s|9981:|8080:|g" docker-compose.yml
cd $CWD